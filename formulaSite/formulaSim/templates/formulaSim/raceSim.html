{% extends "formulaSim/home.html" %}
{% load formulaSim_extras %}
{% load staticfiles %}
{% block extraLinksBlock %}

	

{% endblock extraLinksBlock %}

{% block mainContentBlock %}
	<h3> The RaceSim </h3>
	<br>

	<form class='get-race-form' method='POST' action="{% url 'formulaSim.views.raceSim' %}" enctype="multipart/form-data">
		{% csrf_token %}
		<span>{{ errorMessage }}</span>
		<ul>
			{{the_form.as_ul}}
		</ul>
		<button type="submit" name="submit" value="Get Race">Get Race</button>
	</form>
	<div class='race-info-container'>
	{% if race %}
		<br>
		<div style='display=block; width=100%'>
			<h3>{{ race.name }}</h3>
			<h4>{{ race.date }}</h4>
			<h4>Race ID: {{ race.raceid}}</h4>
		</div>
		<br>
		<br>
	{% endif %}
	{% if drivers %}
		<br>
		{{drivers_id}}
		<ul style='display=block'>
			{% for driver in drivers %}
				<li><h4>{{ driver.forename }} {{ driver.surname }} {{ driver.driverid }}</h4></li>
				{% comment %}
				<ul>
					{% for lap in race.raceid|get_laptime_list:driver.driverid %}
						<li> Lap {{ lap.lap }} time: {{ lap.time }}</li>
					{% endfor %}

				</ul>
				{% endcomment %}
			{% endfor %}
		</ul>
	{% endif %}
</div>

	<canvas id="c" width="600" height="300" style="border:1px solid #c3c3c3;">
		Your browser does not support the HTML5 canvas tag.
	</canvas>


	<script type="text/javascript">
		var c = document.getElementById("c");
		var ctx = c.getContext("2d");
   		var json_drivers = {{ serialized_drivers|safe }};
   		var json_laptimes = {{ serialized_laptimes|safe }};

   		var simulation_drivers = [];

   		function FormulaDriver(lastname, driverid, laptimes, startY, canvasW){
			this.lastname = lastname;
			this.driverid = driverid;
			this.laptimes = laptimes;
			this.trackLength = canvasW;
			this.curPosition = 0;
			this.curLap = 1;
			this.posX = 0;
			this.posY = startY;
			this.curSpeed = 0;

			

			this.updateSpeed = function(){
				this.curSpeed = (this.trackLength / this.laptimes[this.curLap].milliseconds) * 10;
			};

			this.move = function(){
				if(this.curLap = 1)
					this.curSpeed = (this.trackLength / this.laptimes[0].milliseconds) * 10;
				this.posX += this.curSpeed;
				this.checkLapped();

			};

			this.checkLapped = function(){
				if(this.posX >= (this.trackLength))
					this.posX = -20;
				this.curLap += 1;
				this.updateSpeed();
			};

			this.drawRacer = function(ctx){
				ctx.fillStyle = "rgba(2, 150, 250, 1)"
				ctx.fillRect(this.posX, this.posY, 10, 5);

			}
		};


		function get_laptimes(driverid){
			var laptimeslist = []
			for(var i = 0; i < json_laptimes.length; i++){
				if(json_laptimes[i].fields.driverid == driverid)
					laptimeslist.push(json_laptimes[i].fields);
			}
			return laptimeslist;
		}


		function create_drivers(){

			for(var i = 0; i < json_drivers.length; i++){
				var driverFields = json_drivers[i].fields;
				simulation_drivers.push( new FormulaDriver(driverFields.surname, json_drivers[i].pk, 
					get_laptimes(json_drivers[i].pk), 10 + (12*i), 600));
			}
		}



		create_drivers();
   		console.log(simulation_drivers);
   		function draw(){

			

	   		var c = document.getElementById("c");
			var ctx = c.getContext("2d");
			//ctx.fillStyle = "rgba(0, 0, 0, 0.05)";
			//ctx.fillRect(0, 0, c.width, c.height);
			ctx.clearRect(0,0, 600,300);
			//Move cars and draw them
			for(var i = 0; i < simulation_drivers.length; i++){
				simulation_drivers[i].move();
				ctx.fillStyle = "#FF0000";
				ctx.fillRect(simulation_drivers[i].posX, simulation_drivers[i].posY,20,10);

				ctx.fillText(simulation_drivers[i].lastname , simulation_drivers[i].posX + 25, simulation_drivers[i].posY + 8);
				
				//simulation_drivers[i].drawRacer(ctx);
			}
			
			
			}


		setInterval(draw, 1);
	</script>


{% endblock mainContentBlock %}
